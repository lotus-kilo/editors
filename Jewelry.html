<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饰品编辑器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="##000000">
</head>
<link rel="stylesheet" href="../css/styles.css">
<body>
    <div style="margin-bottom: 20px;">
        <button onclick="window.location.href='../index.html'" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">返回首页</button>
    </div>
    <h1>饰品编辑器</h1>
    <form id="itemForm">
        <div class="form-group">
            <label for="name">名称</label>
            <input type="text" id="name" required>
        </div>
        <div class="form-group">
            <label for="essence">本质</label>
            <input type="text" id="essence" required>
        </div>
        <div class="form-group">
            <label for="grade">等级</label>
            <select id="grade" required>
                <option value="D">D</option>
                <option value="C">C</option>
                <option value="B">B</option>
                <option value="A">A</option>
                <option value="S">S</option>
            </select>
        </div>
<!-- 确保qualityDisplay元素存在且可访问 -->
        <div class="form-group">
            <label for="qualityDisplay">品质</label>
            <input type="text" id="qualityDisplay" readonly class="form-control">
        </div>
        <div class="form-group">
            <label>效果/词条</label>
            <div id="effectContainer">
                <div class="effect-item">
                    <textarea class="effect-input" placeholder="输入词条内容" oninput="calculateQuality()" rows="3"></textarea>
                    <select class="effect-quality" onchange="calculateQuality()">
                        <option value="1">白色</option>
                        <option value="2">绿色</option>
                        <option value="3">蓝色</option>
                        <option value="4">紫色</option>
                        <option value="5">金色</option>
                        <option value="6">红色</option>
                    </select>
                    <button type="button" class="btn-danger" onclick="removeEffect(this)">删除</button>
                </div>
            </div>
            <button type="button" class="btn-success" onclick="addEffect()" style="margin-top: 10px;">+ 添加词条</button>
        </div>
        <div class="form-group">
            <label for="description">描述</label>
            <textarea id="description" required oninput="calculatePrice()"></textarea>
        </div>
        <div class="form-group">
            <label for="author">撰写人</label>
            <input type="text" id="author" required oninput="calculatePrice()">
        </div>
        <button type="button" onclick="exportJewelryToTxt()" style="margin-left: 10px; background-color: #2196F3;">导出为TXT</button>
    </form>

    <div id="priceResult" class="price-result" style="display: none;">
        <h2>价格计算结果</h2>
        <p>物品名称: <span id="resultName"></span></p>
        <p>等级: <span id="resultGrade"></span></p>
        <p>品质: <span id="resultQuality"></span></p>
        <p>词条数: <span id="resultEffectCount"></span></p>
        <p>总价格: <span id="resultPrice"></span> 积分</p>
    </div>
</body>
    <div id="seriesActions" style="margin-top: 20px; display: none;">
        <button onclick="saveAndReturnToSeries()" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">保存并返回系列</button>
        <button onclick="saveAsDraft()" style="padding: 8px 16px; background-color: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">保存为草稿</button>
        <button onclick="window.location.href='xilie.html'" style="padding: 8px 16px; background-color: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer;">返回系列页面</button>
    </div>
    <script>
        // 保存为草稿
        function saveAsDraft() {
            const itemData = collectItemData();
            
            const draft = {
                type: '6', // 血统类型
                name: itemData.name || '未命名血统',
                date: new Date().toISOString(),
                data: itemData
            };
            
            // 获取现有草稿
            const drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
            drafts.push(draft);
            localStorage.setItem('drafts', JSON.stringify(drafts));
            
            alert('已保存到草稿箱');
        }
        
        // 收集物品数据
        function collectItemData() {
            return {
                name: document.getElementById('name').value,
                essence: document.getElementById('essence').value,
                grade: document.getElementById('grade').value,
                quality: document.getElementById('qualityDisplay').value,
                description: document.getElementById('description').value,
                author: document.getElementById('author').value,
                effects: Array.from(document.querySelectorAll('.effect-item')).map(item => ({
                    text: item.querySelector('.effect-input').value,
                    color: item.querySelector('.effect-quality').options[item.querySelector('.effect-quality').selectedIndex].text
                }))
            };
        }
    </script>

    <script>
        // 从URL获取系列ID
        const urlParams = new URLSearchParams(window.location.search);
        const fromSeries = urlParams.get('fromSeries');
        
        if (fromSeries) {
            document.getElementById('seriesActions').style.display = 'block';
        }

        function saveAndReturnToSeries() {
            // 调用write.js中的保存函数
            if (typeof saveItem === 'function') {
                saveItem();
            }
            
            // 返回系列页面
            window.location.href = `xilie.html?id=${fromSeries}`;
        }
    </script>

    <script src="../js/Jewelry.js"></script>    
    
 <script src = /main.js></script>> 
</html>